<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NewEnergy • Histórico</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f2f2f2;}
header{background:#111;color:#fff;text-align:center;padding:15px;font-size:20px;}
.container{max-width:950px;margin:auto;padding:15px;}
button{
    padding:10px 16px;background:#111;color:white;border:none;border-radius:6px;
    cursor:pointer;font-size:15px;margin:10px 0;
}
button:hover{opacity:0.8;}
.card{
    background:white;padding:15px;border-radius:12px;box-shadow:0 0 10px rgba(0,0,0,0.1);margin-bottom:20px;
}
h3{margin-top:0;color:#111;}
select{
    padding:10px;border-radius:6px;border:1px solid #ccc;font-size:15px;width:100%;max-width:200px;
}
table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{padding:10px;text-align:center;border-bottom:1px solid #ddd;}
th{background:#111;color:white;}
canvas{width:100%;height:280px !important;}
</style>
</head>

<body>

<header>Histórico de Leituras • NewEnergy</header>

<div class="container">

<button onclick="window.location.href='painel.html'">⬅ Voltar ao Painel</button>

<div class="card">
    <h3>Filtros</h3>
    <select id="filtro">
        <option value="total">Tudo</option>
        <option value="dia">Hoje</option>
        <option value="semana">Últimos 7 dias</option>
        <option value="mes">Este mês</option>
    </select>
    <button onclick="carregarHistorico()">Aplicar</button>
</div>

<div class="card">
    <h3>Gráfico</h3>
    <canvas id="grafico"></canvas>
</div>

<div class="card">
    <h3>Tabela de Registros</h3>
    <table>
        <thead>
            <tr>
                <th>Data/Hora</th>
                <th>Temperatura (°C)</th>
                <th>Umidade (%)</th>
            </tr>
        </thead>
        <tbody id="tabela"></tbody>
    </table>
</div>

</div>

<script>
// ======== CONFIG FIREBASE (mesmo do painel/login) =========
const firebaseConfig = {
    apiKey:"AIzaSyAEgLyJ6i2ZaSNnBrLMoe2ajInd4MGKHIs",
    authDomain:"controle-led-esp-oficial.firebaseapp.com",
    databaseURL:"https://controle-led-esp-oficial-default-rtdb.firebaseio.com",
    projectId:"controle-led-esp-oficial",
    storageBucket:"controle-led-esp-oficial.firebasestorage.app",
    messagingSenderId:"1082980860084",
    appId:"1:1082980860084:web:b3b669b8f1801c3d6657e1"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.database();

let espID = "";

// Verifica login e puxa o ID do ESP
auth.onAuthStateChanged(user => {
    if (!user) return window.location.href = "index.html";
    db.ref("usuarios/" + user.uid + "/esp32ID").once("value")
    .then(snap => {
        espID = snap.val();
        if (!espID) {
            alert("Nenhum ESP32 vinculado!");
            return;
        }
        carregarHistorico();
    });
});

// ==== Gráfico ====
let ctx = document.getElementById("grafico").getContext("2d");
let grafico = new Chart(ctx, {
    type: "line",
    data: {
        labels: [],
        datasets: [
            { label: "Temperatura (°C)", data: [], borderColor: "red", fill: false },
            { label: "Umidade (%)", data: [], borderColor: "blue", fill: false }
        ]
    },
    options: { responsive: true }
});

// ==== Carregar dados ====
function carregarHistorico(){
    if (!espID) return;

    const filtro = document.getElementById("filtro").value;
    const tabela = document.getElementById("tabela");

    db.ref("historico/" + espID).once("value").then(snap => {
        tabela.innerHTML = "";
        let labels = [], temp = [], umid = [];

        const agora = new Date();
        const dados = snap.val();

        if (!dados) {
            tabela.innerHTML = "<tr><td colspan='3'>Nenhum registro encontrado</td></tr>";
            return;
        }

        for (const key in dados){
            const item = dados[key];

            const dt = new Date(item.timestamp);

            let incluir = true;

            if (filtro === "dia") incluir = dt.toDateString() === agora.toDateString();
            if (filtro === "semana") incluir = (agora - dt) <= 7*24*60*60*1000;
            if (filtro === "mes") incluir = (dt.getMonth() === agora.getMonth() && dt.getFullYear() === agora.getFullYear());

            if (!incluir) continue;

            labels.push(dt.toLocaleString());
            temp.push(item.temperatura);
            umid.push(item.umidade);

            tabela.innerHTML = `
                <tr>
                    <td>${dt.toLocaleString()}</td>
                    <td>${item.temperatura}</td>
                    <td>${item.umidade}</td>
                </tr>
            ` + tabela.innerHTML;
        }

        grafico.data.labels = labels;
        grafico.data.datasets[0].data = temp;
        grafico.data.datasets[1].data = umid;
        grafico.update();
    });
}
</script>

</body>
</html>
