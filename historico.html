<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NewEnergy • Histórico Completo</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
*{box-sizing:border-box;}
body{margin:0;padding:0;font-family:Arial,sans-serif;background:#000;color:white;}
header{background:#111;padding:15px;text-align:center;font-size:18px;color:#f1c40f;border-bottom:1px solid #222;}
.container{padding:10px;max-width:1000px;margin:auto;display:flex;flex-direction:column;gap:15px;}
.card{background:#111;padding:15px;border-radius:10px;border:1px solid #333;box-shadow:0 0 6px rgba(255,255,0,0.1);}
.card h3{margin-bottom:10px;font-size:16px;color:#f1c40f;}
select,button{padding:10px;margin-top:5px;border-radius:6px;border:none;font-size:14px;}
button{background:#f1c40f;color:#000;font-weight:bold;cursor:pointer;transition:0.3s;}
button:hover{background:#ffe35a;}
table{width:100%;border-collapse:collapse;margin-top:10px;max-height:300px;overflow-y:auto;display:block;}
th,td{padding:6px;text-align:center;border:1px solid #333;}
thead{background:#222;display:table;width:100%;table-layout:fixed;}
tbody{display:block;height:250px;overflow-y:auto;width:100%;}
canvas{width:100%!important;height:250px!important;display:block;margin:auto;}
@media(max-width:600px){
  header{font-size:16px;}
  button, select{font-size:12px;padding:8px;}
  .card h3{font-size:14px;}
}
</style>
</head>
<body>
<header>Histórico Completo • NewEnergy</header>
<div class="container">

<div class="card">
  <h3>Filtros</h3>
  <select id="periodo">
    <option value="diario">Diário</option>
    <option value="semanal">Semanal</option>
    <option value="mensal">Mensal</option>
    <option value="anual">Anual</option>
  </select>
  <button id="btnFiltrar">Aplicar Filtro</button>
  <button id="btnRelatorio">Gerar PDF</button>
</div>

<div class="card">
  <h3>Gráfico do Período</h3>
  <canvas id="graficoHistorico"></canvas>
</div>

<div class="card">
  <h3>Tabela de Leituras</h3>
  <table id="tabelaHistorico">
    <thead>
      <tr><th>Data/Hora</th><th>Temperatura (°C)</th><th>Umidade (%)</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

</div>

<script>
const firebaseConfig = {
  apiKey:"AIzaSyAEgLyJ6i2ZaSNnBrLMoe2ajInd4MGKHIs",
  authDomain:"controle-led-esp-oficial.firebaseapp.com",
  databaseURL:"https://controle-led-esp-oficial-default-rtdb.firebaseio.com",
  projectId:"controle-led-esp-oficial",
  storageBucket:"controle-led-esp-oficial.firebasestorage.app",
  messagingSenderId:"1082980860084",
  appId:"1:1082980860084:web:b3b669b8f1801c3d6657e1"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

const periodoEl = document.getElementById("periodo");
const btnFiltrar = document.getElementById("btnFiltrar");
const btnRelatorio = document.getElementById("btnRelatorio");
const tabelaBody = document.querySelector("#tabelaHistorico tbody");
const ctxGrafico = document.getElementById("graficoHistorico");

let graficoHistorico = new Chart(ctxGrafico,{
    type:"line",
    data:{
      labels:[],
      datasets:[
        {label:"Temperatura",data:[],borderColor:"#ff3b3b",fill:false,tension:0.3},
        {label:"Umidade",data:[],borderColor:"#3498db",fill:false,tension:0.3}
      ]
    },
    options:{
      plugins:{legend:{display:true}},
      scales:{y:{beginAtZero:true}}
    }
});

let espID="";
let dadosHistorico = {};

auth.onAuthStateChanged(user=>{
    if(user){
        const uid = user.uid;
        db.ref("/usuarios/"+uid+"/esp32ID").once("value").then(snapshot=>{
            espID = snapshot.val();
            if(!espID){alert("Nenhum ESP32 vinculado!"); return;}
            carregarHistorico();
            setInterval(carregarHistorico,5000); // Atualiza a cada 5s
        });
    } else {
        alert("Usuário não logado!");
        window.location.href="index.html";
    }
});

function carregarHistorico(){
    if(!espID) return;
    db.ref("/historico/"+espID).once("value").then(snapshot=>{
        const data = snapshot.val();
        if(!data) return;
        dadosHistorico = data;
        filtrarHistorico();
    });
}

function filtrarHistorico(){
    const periodo = periodoEl.value;
    let labels=[], tempData=[], umidData=[], tbodyHTML="";
    const agora = new Date();

    Object.keys(dadosHistorico).sort((a,b)=>b-a).forEach(key=>{
        const item = dadosHistorico[key];
        const dt = new Date(item.timestamp);
        let incluir=false;

        switch(periodo){
          case "diario":
            if(dt.toDateString()===agora.toDateString()) incluir=true;
            break;
          case "semanal":
            if((agora-dt)<=7*24*60*60*1000) incluir=true;
            break;
          case "mensal":
            if(agora.getMonth()===dt.getMonth() && agora.getFullYear()===dt.getFullYear()) incluir=true;
            break;
          case "anual":
            if(agora.getFullYear()===dt.getFullYear()) incluir=true;
            break;
        }

        if(incluir){
            labels.push(dt.toLocaleString());
            tempData.push(item.temperatura);
            umidData.push(item.umidade);
            tbodyHTML += `<tr><td>${dt.toLocaleString()}</td><td>${item.temperatura}</td><td>${item.umidade}</td></tr>`;
        }
    });

    graficoHistorico.data.labels = labels.reverse(); // mostra mais recente à direita
    graficoHistorico.data.datasets[0].data = tempData.reverse();
    graficoHistorico.data.datasets[1].data = umidData.reverse();
    graficoHistorico.update();
    tabelaBody.innerHTML = tbodyHTML;
}

btnFiltrar.addEventListener("click", filtrarHistorico);

btnRelatorio.addEventListener("click", ()=>{
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(16);
    doc.text("Relatório de Leituras - NewEnergy",10,15);
    doc.setFontSize(12);
    doc.text("Período: "+periodoEl.value,10,25);

    let y=35;
    tabelaBody.querySelectorAll("tr").forEach(tr=>{
        const td = tr.querySelectorAll("td");
        doc.text(`${td[0].innerText} | Temp: ${td[1].innerText}°C | Umid: ${td[2].innerText}%`,10,y);
        y+=7;
        if(y>280){doc.addPage(); y=10;}
    });
    doc.save(`relatorio_${periodoEl.value}.pdf`);
});
</script>
</body>
</html>
