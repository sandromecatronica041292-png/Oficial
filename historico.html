<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>NewEnergy - Hist√≥rico</title>

<style>
body {
  margin: 0;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: #0b0f1b;
  color: #fff;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  padding: 20px;
}
.card {
  background: #1b1f33;
  border-radius: 15px;
  padding: 20px;
  width: 95%;
  max-width: 650px;
  max-height: 95vh;
  display: flex;
  flex-direction: column;
  box-shadow: 0 10px 25px rgba(0,0,0,0.7);
}
h1 {
  text-align: center;
  color: #00bcd4;
  margin-bottom: 10px;
}
.tabs { display: flex; margin-bottom: 10px; overflow-x: auto; }
.tab {
  flex: 1;
  padding: 8px;
  text-align: center;
  cursor: pointer;
  border-radius: 10px 10px 0 0;
  background: #0c1424;
  margin-right: 2px;
  font-size: 14px;
  white-space: nowrap;
}
.tab.active { background: #00bcd4; color: #0b0f1b; }

#lista { overflow-y: auto; flex: 1; padding-right: 5px; font-size: 14px; max-height: 200px; margin-bottom: 10px; }

.item {
  background: #0c1424;
  padding: 8px;
  border-radius: 10px;
  margin-bottom: 6px;
  box-shadow: inset 0 0 8px rgba(0,0,0,0.4);
}
.data { color: #8fa3c6; margin-bottom: 2px; }
.valor { font-weight: bold; color: #00bcd4; }

.btn-container { display: flex; gap: 10px; margin-top: 5px; flex-wrap: wrap; }
.btn {
  flex: 1;
  padding: 10px;
  border: none;
  border-radius: 10px;
  background: #ff5722;
  font-size: 14px;
  cursor: pointer;
  color: white;
}

.select-period {
  background: #0c1424;
  color: #fff;
  border: none;
  border-radius: 10px;
  padding: 8px;
  font-size: 14px;
  cursor: pointer;
}

canvas { background: #0c1424; border-radius: 10px; margin-top: 10px; }
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body>

<div class="card">
  <h1>Hist√≥rico de Leituras</h1>

  <div class="tabs">
    <div class="tab active" onclick="showTab('diario')">Di√°rio</div>
    <div class="tab" onclick="showTab('semanal')">Semanal</div>
    <div class="tab" onclick="showTab('mensal')">Mensal</div>
    <div class="tab" onclick="showTab('anual')">Anual</div>
  </div>

  <div id="lista"></div>

  <canvas id="grafico" height="200"></canvas>

  <div class="btn-container">
    <select id="periodoPDF" class="select-period">
      <option value="diario">PDF Di√°rio</option>
      <option value="semanal">PDF Semanal</option>
      <option value="mensal">PDF Mensal</option>
      <option value="anual">PDF Anual</option>
    </select>
    <button class="btn" onclick="exportPDF()">Exportar PDF</button>
    <button class="btn" onclick="window.location.href='painel.html'">Voltar</button>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyB5FnkQiFi3gn9Iup2KNcbrKxWd-0Jjo6Y",
  authDomain: "oficial-688e8.firebaseapp.com",
  databaseURL: "https://oficial-688e8-default-rtdb.firebaseio.com/",
  projectId: "oficial-688e8",
  storageBucket: "oficial-688e8.firebasestorage.app",
  messagingSenderId: "547217835774",
  appId: "1:547217835774:web:c7186da5bf6156590c47af"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();
auth.onAuthStateChanged(user => { if(!user) window.location.href="index.html"; });

let currentTab = 'diario';
let chart;

function getFiltro(tab){
  const now = Math.floor(Date.now()/1000);
  switch(tab){
    case 'diario': return now - 86400;
    case 'semanal': return now - 604800;
    case 'mensal': return now - 2592000;
    case 'anual': return now - 31536000;
    default: return 0;
  }
}

function showTab(tab){
  currentTab = tab;
  document.querySelectorAll('.tab').forEach(el=>el.classList.remove('active'));
  event.target.classList.add('active');
  carregarHistorico(tab);
}

function carregarHistorico(tab){
  const LISTA = document.getElementById("lista");
  LISTA.innerHTML = "<p>Carregando...</p>";
  const REF = db.ref("/historico");

  REF.once("value", snap=>{
    const dados = snap.val();
    const tsFiltro = getFiltro(tab);
    let registros = [];

    if(!dados){ LISTA.innerHTML="<p>Nenhum registro encontrado.</p>"; return; }

    Object.keys(dados).sort((a,b)=>b-a).forEach(ts=>{
      if(parseInt(ts) < tsFiltro) return;
      const item = dados[ts];
      const date = new Date(parseInt(ts)*1000).toLocaleString("pt-BR");
      registros.push({date,item});
    });

    if(registros.length===0){ LISTA.innerHTML="<p>Nenhum registro neste per√≠odo.</p>"; 
      if(chart){ chart.destroy(); }
      return;
    }

    LISTA.innerHTML = "";
    registros.forEach(r=>{
      LISTA.innerHTML += `<div class="item">
        <div class="data">${r.date}</div>
        <div class="valor">üå° Temp: ${r.item.temperatura} ¬∞C</div>
        <div class="valor">üíß Umidade: ${r.item.umidade} %</div>
      </div>`;
    });

    // Atualizar gr√°fico
    const labels = registros.map(r=>r.date).reverse();
    const tempData = registros.map(r=>r.item.temperatura).reverse();
    const humData = registros.map(r=>r.item.umidade).reverse();

    const ctx = document.getElementById('grafico').getContext('2d');
    if(chart){ chart.destroy(); }
    chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          { label: 'Temperatura (¬∞C)', data: tempData, borderColor:'#ff5722', backgroundColor:'rgba(255,87,34,0.2)', tension:0.3 },
          { label: 'Umidade (%)', data: humData, borderColor:'#00bcd4', backgroundColor:'rgba(0,188,212,0.2)', tension:0.3 }
        ]
      },
      options: { responsive:true, maintainAspectRatio:false, scales:{x:{ticks:{color:'#fff'}}, y:{ticks:{color:'#fff'}}} }
    });
  });
}

function exportPDF(){
  const periodo = document.getElementById("periodoPDF").value;
  const tsFiltro = getFiltro(periodo);
  const REF = db.ref("/historico");

  REF.once("value", snap=>{
    const dados = snap.val();
    if(!dados){ alert("Nenhum registro encontrado."); return; }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({orientation:'p', unit:'pt', format:'a4'});
    let y = 40;
    doc.setFontSize(14);
    doc.setTextColor(0,188,212);
    doc.text("Hist√≥rico - " + periodo.charAt(0).toUpperCase() + periodo.slice(1),40,y); y+=20;

    let count = 0;
    Object.keys(dados).sort((a,b)=>b-a).forEach(ts=>{
      if(parseInt(ts) < tsFiltro) return;
      const item = dados[ts];
      const date = new Date(parseInt(ts)*1000).toLocaleString("pt-BR");

      doc.setTextColor(255,255,255);
      doc.setFontSize(12);
      doc.text(`Data: ${date}`,40,y); y+=12;
      doc.text(`üå° Temp: ${item.temperatura} ¬∞C  üíß Umidade: ${item.umidade} %`,40,y); y+=14;
      count++;
      if(y>750){ doc.addPage(); y=40; }
    });

    if(count===0){ alert("Nenhum registro dispon√≠vel para o per√≠odo selecionado."); return; }
    doc.save("historico_" + periodo + ".pdf");
  });
}

// Inicial
showTab('diario');
</script>
</body>
</html>
