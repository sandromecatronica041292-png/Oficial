<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>NewEnergy - HistÃ³rico</title>

<style>
body { margin:0; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#0b0f1b; color:#fff; display:flex; justify-content:center; align-items:flex-start; padding:20px; }
.card { background:#1b1f33; border-radius:15px; padding:20px; width:600px; max-height:95vh; display:flex; flex-direction:column; box-shadow:0 10px 25px rgba(0,0,0,0.7); }
h1 { text-align:center; color:#00bcd4; margin-bottom:10px; }
.tabs { display:flex; margin-bottom:10px; }
.tab { flex:1; padding:8px; text-align:center; cursor:pointer; border-radius:10px 10px 0 0; background:#0c1424; margin-right:2px; font-size:14px; }
.tab.active { background:#00bcd4; color:#0b0f1b; }

#grafico-container { overflow-x:auto; margin-bottom:10px; }
#grafico-temp, #grafico-hum { min-width:500px; height:220px; margin-bottom:10px; }

#lista { overflow-y:auto; flex:1; padding-right:5px; font-size:14px; max-height:250px; }

.item { background:#0c1424; padding:8px; border-radius:10px; margin-bottom:6px; box-shadow:inset 0 0 8px rgba(0,0,0,0.4); }
.data { color:#8fa3c6; margin-bottom:2px; }
.valor { font-weight:bold; color:#00bcd4; }

.btn-container { display:flex; gap:10px; margin-top:8px; }
.btn { flex:1; padding:10px; border:none; border-radius:10px; background:#ff5722; font-size:14px; cursor:pointer; color:white; }
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<div class="card">
  <h1>HistÃ³rico de Leituras</h1>

  <div class="tabs">
    <div class="tab active" onclick="showTab('diario')">DiÃ¡rio</div>
    <div class="tab" onclick="showTab('semanal')">Semanal</div>
    <div class="tab" onclick="showTab('mensal')">Mensal</div>
    <div class="tab" onclick="showTab('anual')">Anual</div>
  </div>

  <div id="grafico-container">
    <canvas id="grafico-temp"></canvas>
    <canvas id="grafico-hum"></canvas>
  </div>

  <div id="lista"></div>

  <div class="btn-container">
    <button class="btn" onclick="exportPDFTodos()">Exportar PDF</button>
    <button class="btn" onclick="window.location.href='painel.html'">Voltar</button>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey:"AIzaSyB5FnkQiFi3gn9Iup2KNcbrKxWd-0Jjo6Y",
  authDomain:"oficial-688e8.firebaseapp.com",
  databaseURL:"https://oficial-688e8-default-rtdb.firebaseio.com/",
  projectId:"oficial-688e8",
  storageBucket:"oficial-688e8.firebasestorage.app",
  messagingSenderId:"547217835774",
  appId:"1:547217835774:web:c7186da5bf6156590c47af"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();
auth.onAuthStateChanged(user=>{if(!user) window.location.href="index.html";});

let currentTab='diario';
let chartTemp, chartHum;
let historicosTodos={};

function showTab(tab){
  currentTab=tab;
  document.querySelectorAll('.tab').forEach(el=>el.classList.remove('active'));
  event.target.classList.add('active');
  carregarHistorico(tab);
}

function carregarHistorico(tab){
  const LISTA=document.getElementById("lista");
  LISTA.innerHTML="<p>Carregando...</p>";
  const REF=db.ref("/historico/"+tab);

  REF.once("value",snap=>{
    const dados=snap.val();
    historicosTodos[tab]=dados||{};
    if(!dados){ LISTA.innerHTML="<p>Nenhum registro encontrado.</p>"; if(chartTemp) chartTemp.destroy(); if(chartHum) chartHum.destroy(); return; }

    LISTA.innerHTML="";
    const labels=[], tempData=[], humData=[];

    const chavesPeriodo=Object.keys(dados).sort((a,b)=>b.localeCompare(a));
    chavesPeriodo.forEach(periodo=>{
      const registros=dados[periodo];
      const timestamps=Object.keys(registros).sort((a,b)=>b-a);
      timestamps.forEach(ts=>{
        const item=registros[ts];
        const date=new Date(parseInt(ts)*1000).toLocaleString("pt-BR");

        LISTA.innerHTML+=`<div class="item">
          <div class="data">${date}</div>
          <div class="valor">ðŸŒ¡ Temp: ${item.temperatura} Â°C</div>
          <div class="valor">ðŸ’§ Umidade: ${item.umidade} %</div>
        </div>`;

        labels.push(date);
        tempData.push(item.temperatura);
        humData.push(item.umidade);
      });
    });

    const ctxT=document.getElementById('grafico-temp').getContext('2d');
    if(chartTemp) chartTemp.destroy();
    chartTemp=new Chart(ctxT,{
      type:'line',
      data:{labels:labels.reverse(), datasets:[{label:'Temperatura (Â°C)', data:tempData.reverse(), borderColor:'#ff9800', backgroundColor:'rgba(255,152,0,0.2)', fill:true}]},
      options:{responsive:true, plugins:{legend:{labels:{color:'#fff'}}}, scales:{x:{ticks:{color:'#fff', maxRotation:45, minRotation:0}}, y:{ticks:{color:'#fff'}}}}
    });

    const ctxH=document.getElementById('grafico-hum').getContext('2d');
    if(chartHum) chartHum.destroy();
    chartHum=new Chart(ctxH,{
      type:'line',
      data:{labels:labels.reverse(), datasets:[{label:'Umidade (%)', data:humData.reverse(), borderColor:'#00bcd4', backgroundColor:'rgba(0,188,212,0.2)', fill:true}]},
      options:{responsive:true, plugins:{legend:{labels:{color:'#fff'}}}, scales:{x:{ticks:{color:'#fff', maxRotation:45, minRotation:0}}, y:{ticks:{color:'#fff'}}}
    });
  });
}

// PDF
function exportPDFTodos(){
  const { jsPDF }=window.jspdf;
  const doc=new jsPDF({orientation:'p', unit:'pt', format:'a4'});
  let pagina=0;

  for(const tab in historicosTodos){
    const dados=historicosTodos[tab];
    if(!dados) continue;

    if(pagina>0) doc.addPage();
    pagina++;

    let y=40;
    doc.setFontSize(14);
    doc.setTextColor(0,188,212);
    doc.text("HistÃ³rico - "+tab.charAt(0).toUpperCase()+tab.slice(1),40,y); y+=20;

    const chavesPeriodo=Object.keys(dados).sort((a,b)=>b.localeCompare(a));
    chavesPeriodo.forEach(periodo=>{
      const registros=dados[periodo];
      const timestamps=Object.keys(registros).sort((a,b)=>b-a);
      timestamps.forEach(ts=>{
        const item=registros[ts];
        const date=new Date(parseInt(ts)*1000).toLocaleString("pt-BR");
        doc.setTextColor(255,255,255);
        doc.setFontSize(12);
        doc.text(`Data: ${date}`,40,y); y+=12;
        doc.text(`ðŸŒ¡ Temp: ${item.temperatura} Â°C  ðŸ’§ Umidade: ${item.umidade} %`,40,y); y+=14;
        if(y>750){ doc.addPage(); y=40; }
      });
    });
  }

  alert("PDF gerado com todos os perÃ­odos (dados).");
  doc.save("historico_todos_periodos.pdf");
}

// Inicial
showTab('diario');
</script>
</body>
</html>
